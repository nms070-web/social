<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ ì§€ì—­ 4ì»· ë§Œí™” ë§Œë“¤ê¸° (AI ê·¸ë¦¼)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .comic-panel {
            border: 2px solid #d1d5db; /* gray-300 */
            background-color: #ffffff;
            cursor: pointer;
            touch-action: none;
            /* ìƒì„±ëœ ì´ë¯¸ì§€ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            /* í”Œë ˆì´ìŠ¤í™€ë” í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af; /* gray-400 */
            text-align: center;
            font-size: 0.875rem; /* text-sm */
            padding: 1rem;
            /* ëŒ€ì‚¬ ë„£ê¸°ë¥¼ ìœ„í•œ position relative ì¶”ê°€ */
            position: relative; 
            overflow: hidden; /* ëŒ€ì‚¬ê°€ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ */
        }
        .comic-panel:hover {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
        }
        .tool-btn {
            @apply px-4 py-2 rounded-lg transition-all text-sm font-medium shadow;
        }
        /* í™œì„±í™”ëœ íˆ´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tool-toggle-btn {
            @apply px-4 py-2 rounded-lg transition-all text-sm font-medium border-2;
        }
        .tool-toggle-btn.active {
            @apply bg-blue-600 text-white border-blue-600 shadow-md;
        }
        .tool-toggle-btn:not(.active) {
            @apply bg-white text-gray-700 border-gray-300 hover:bg-gray-50;
        }

        /* ë¡œë” ìŠ¤íƒ€ì¼ */
        .loader {
            border-top-color: transparent;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* ëŒ€ì‚¬ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .dialogue-text {
            position: absolute;
            bottom: 8px;
            left: 8px;
            right: 8px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            color: #1f2937; /* gray-800 */
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            line-height: 1.4;
            /* ì—¬ëŸ¬ ì¤„ í…ìŠ¤íŠ¸ë¥¼ ìœ„í•´ */
            white-space: pre-wrap;
            word-break: keep-all;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl p-4 sm:p-6">
        <!-- í—¤ë” -->
        <header class="text-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">ìš°ë¦¬ ì§€ì—­ 4ì»· ë§Œí™” ë§Œë“¤ê¸° (AI ê·¸ë¦¼) ğŸ¤–</h1>
            <p class="text-gray-600 mt-1">AIë¡œ ê·¸ë¦¼ì„ ë§Œë“¤ê³ , ì§ì ‘ ëŒ€ì‚¬ë¥¼ ë„£ì–´ ë§Œí™”ë¥¼ ì™„ì„±í•´ ë³´ì„¸ìš”!</p>
        </header>

        <!-- ë©”ì¸ ì»¨í…ì¸ : ë²„íŠ¼ + ë§Œí™” ê·¸ë¦¬ë“œ -->
        <main>
            <!-- ë„êµ¬ ì„ íƒ -->
            <div class="flex gap-2 justify-center mb-4">
                <button id="tool-image" class="tool-toggle-btn active">ğŸ–¼ï¸ ê·¸ë¦¼ ë„£ê¸°</button>
                <button id="tool-text" class="tool-toggle-btn">ğŸ’¬ ëŒ€ì‚¬ ë„£ê¸°</button>
            </div>
            
            <!-- ë©”ì¸ ë²„íŠ¼ -->
            <div class="flex flex-col sm:flex-row gap-2 justify-center mb-6">
                <button id="get-idea" class="tool-btn bg-purple-500 text-white hover:bg-purple-600">âœ¨ ë§Œí™” ìŠ¤í† ë¦¬ ì¶”ì²œ</button>
                <button id="clear-all" class="tool-btn bg-red-500 text-white hover:bg-red-600">ì»· ëª¨ë‘ ë¹„ìš°ê¸°</button>
                <button id="save-comic" class="tool-btn bg-green-500 text-white hover:bg-green-600">ğŸ–¼ï¸ ë§Œí™” ì €ì¥í•˜ê¸°</button>
            </div>

            <!-- 4ì»· ë§Œí™” ê·¸ë¦¬ë“œ -->
            <section id="comic-container" class="flex-1">
                <div id="comic-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4 bg-gray-200 p-4 rounded-lg">
                    <div id="panel-1" class="comic-panel w-full aspect-square">
                        <span class="placeholder-text">1ì»·: í´ë¦­í•´ì„œ ê·¸ë¦¼/ëŒ€ì‚¬ ì¶”ê°€</span>
                    </div>
                    <div id="panel-2" class="comic-panel w-full aspect-square">
                        <span class="placeholder-text">2ì»·: í´ë¦­í•´ì„œ ê·¸ë¦¼/ëŒ€ì‚¬ ì¶”ê°€</span>
                    </div>
                    <div id="panel-3" class="comic-panel w-full aspect-square">
                        <span class="placeholder-text">3ì»·: í´ë¦­í•´ì„œ ê·¸ë¦¼/ëŒ€ì‚¬ ì¶”ê°€</span>
                    </div>
                    <div id="panel-4" class="comic-panel w-full aspect-square">
                        <span class="placeholder-text">4ì»·: í´ë¦­í•´ì„œ ê·¸ë¦¼/ëŒ€ì‚¬ ì¶”ê°€</span>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ì €ì¥ ë¡œë”© ëª¨ë‹¬ -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <p class="text-lg font-medium">ë§Œí™”ë¥¼ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
    </div>

    <!-- ì•„ì´ë””ì–´ ìƒì„± ëª¨ë‹¬ (Gemini í…ìŠ¤íŠ¸) -->
    <div id="idea-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <!-- ... (ì´ ëª¨ë‹¬ì˜ ë‚´ìš©ì€ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤) ... -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">âœ¨ ë§Œí™” ìŠ¤í† ë¦¬ ì¶”ì²œê¸°</h2>
            <p class="text-gray-600 mb-3 text-sm">ìš°ë¦¬ ì§€ì—­ì˜ ìë‘ê±°ë¦¬ (ì˜ˆ: 'ì²­ì£¼ ì‚¼ê²¹ì‚´')ë¥¼ ì…ë ¥í•˜ë©´, 4ì»· ë§Œí™” ìŠ¤í† ë¦¬ë¥¼ ì¶”ì²œí•´ ì¤„ê²Œìš”!</p>
            <input type="text" id="idea-prompt" class="w-full rounded-md border-gray-300 shadow-sm" placeholder="ìë‘ê±°ë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <div id="idea-loading" class="hidden my-4 text-center">
                <div class="loader inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-gray-500 mt-2">ì•„ì´ë””ì–´ë¥¼ ìƒê° ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
            <div id="idea-result" class="my-4 p-3 bg-gray-50 rounded-md hidden max-h-48 overflow-y-auto"></div>
            <div class="flex flex-col sm:flex-row gap-2 mt-6">
                <button id="generate-idea-btn" class="w-full tool-btn bg-blue-500 text-white hover:bg-blue-600">ìƒì„±í•˜ê¸°</button>
                <button id="close-idea-modal" class="w-full tool-btn bg-gray-300 text-gray-700 hover:bg-gray-400">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- AI ì´ë¯¸ì§€ ìƒì„± ëª¨ë‹¬ (Gemini ì´ë¯¸ì§€) -->
    <div id="image-gen-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <!-- ... (ì´ ëª¨ë‹¬ì˜ ë‚´ìš©ì€ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤) ... -->
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">âœ¨ ì»· ê·¸ë¦¼ ìƒì„±í•˜ê¸°</h2>
            <p class="text-gray-600 mb-3 text-sm">ì´ ì»·ì— ì–´ë–¤ ê·¸ë¦¼ì„ ê·¸ë¦´ê¹Œìš”? (ì•„ë˜ ì˜ˆì‹œë¥¼ ì°¸ê³ í•´ ë³´ì„¸ìš”!)</p>
            <input type="text" id="image-prompt" class="w-full rounded-md border-gray-300 shadow-sm" placeholder="ì˜ˆ: ì†ì´ˆ ë°”ë‹¤ì—ì„œ ì¶¤ì¶”ëŠ” ê°•ì•„ì§€">
            
            <!-- (ì‹ ê·œ) í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ ì¶”ê°€ -->
            <div class="mt-4 text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">
                <p class="font-medium text-gray-600 mb-2">ğŸ’¡ ì´ë ‡ê²Œ ì„¤ëª…í•˜ë©´ ê·¸ë¦¼ì´ ì˜ ë‚˜ì™€ìš”!</p>
                <ul class="list-disc list-inside space-y-1">
                    <li><b>ëˆ„ê°€/ë¬´ì—‡ì„:</b> 'ì›ƒê³  ìˆëŠ” ì•„ì´', 'ì»¤ë‹¤ë€ ì†Œë‚˜ë¬´', 'ê·€ì—¬ìš´ ê°•ì•„ì§€'</li>
                    <li><b>ì–´ë””ì—ì„œ:</b> 'ì²­ì£¼ ì¤‘ì•™ê³µì›ì—ì„œ', 'ì†ì´ˆ ë°”ë‹¤ ì•ì—ì„œ', 'ìš°ë¦¬ í•™êµ ìš´ë™ì¥ì—ì„œ'</li>
                    <li><b>ë¬´ì—‡ì„ í•˜ë‚˜ìš”:</b> 'ì‹ ë‚˜ê²Œ ì¶¤ì„ ì¶”ëŠ”', 'ê°€ë§Œíˆ ì„œ ìˆëŠ”', 'ì¹œêµ¬ì™€ ë–¡ë³¶ì´ë¥¼ ë¨¹ëŠ”'</li>
                </ul>
                <p class="mt-2 font-medium text-gray-600">ğŸ‘‰ <b>í•©ì³ë³´ê¸°:</b> 'ì†ì´ˆ ë°”ë‹¤ ì•ì—ì„œ ì‹ ë‚˜ê²Œ ì¶¤ì„ ì¶”ëŠ” ê·€ì—¬ìš´ ê°•ì•„ì§€'</p>
            </div>
            
            <div id="image-loading" class="hidden my-4 text-center">
                <div class="loader inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <p class="text-gray-500 mt-2">AIê°€ ê·¸ë¦¼ì„ ê·¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
            
            <div id="image-preview" class="my-4 p-3 bg-gray-50 rounded-md hidden min-h-[100px]">
                <!-- AIê°€ ìƒì„±í•œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="flex flex-col sm:flex-row gap-2 mt-6">
                <button id="generate-image-btn" class="w-full tool-btn bg-blue-500 text-white hover:bg-blue-600">ê·¸ë¦¼ ìƒì„±í•˜ê¸°</button>
                <button id="apply-image-btn" class="w-full tool-btn bg-green-500 text-white hover:bg-green-600 hidden">ì´ ê·¸ë¦¼ìœ¼ë¡œ ì ìš©</button>
                <button id="close-image-gen-modal" class="w-full tool-btn bg-gray-300 text-gray-700 hover:bg-gray-400">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
    
    <!-- (ì‹ ê·œ) ëŒ€ì‚¬ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="text-add-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">ğŸ’¬ ëŒ€ì‚¬ ì¶”ê°€í•˜ê¸°</h2>
            <p class="text-gray-600 mb-3 text-sm">ì´ ì»·ì— ë“¤ì–´ê°ˆ ëŒ€ì‚¬ë‚˜ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
            <textarea id="text-input" class="w-full rounded-md border-gray-300 shadow-sm" rows="3" placeholder="ëŒ€ì‚¬ë¥¼ ì…ë ¥..."></textarea>
            <div class="flex flex-col sm:flex-row gap-2 mt-6">
                <button id="apply-text-btn" class="w-full tool-btn bg-blue-500 text-white hover:bg-blue-600">ëŒ€ì‚¬ ì ìš©í•˜ê¸°</button>
                <button id="close-text-modal" class="w-full tool-btn bg-gray-300 text-gray-700 hover:bg-gray-400">ë‹«ê¸°</button>
            </div>
        </div>
    </div>


    <script>
        window.addEventListener('load', () => {
            const comicGrid = document.getElementById('comic-grid');
            const comicPanels = [
                document.getElementById('panel-1'),
                document.getElementById('panel-2'),
                document.getElementById('panel-3'),
                document.getElementById('panel-4'),
            ];

            // --- UI ìš”ì†Œ ---
            const clearAllBtn = document.getElementById('clear-all');
            const saveBtn = document.getElementById('save-comic');
            const loadingModal = document.getElementById('loading-modal');
            
            // --- (ì‹ ê·œ) íˆ´ ì„ íƒ UI ---
            const toolImageBtn = document.getElementById('tool-image');
            const toolTextBtn = document.getElementById('tool-text');
            let currentTool = 'image'; // 'image' ë˜ëŠ” 'text'

            // --- Gemini (í…ìŠ¤íŠ¸) ì•„ì´ë””ì–´ ëª¨ë‹¬ UI ---
            const getIdeaBtn = document.getElementById('get-idea');
            const ideaModal = document.getElementById('idea-modal');
            const closeIdeaModalBtn = document.getElementById('close-idea-modal');
            const generateIdeaBtn = document.getElementById('generate-idea-btn');
            const ideaPromptInput = document.getElementById('idea-prompt');
            const ideaLoading = document.getElementById('idea-loading');
            const ideaResult = document.getElementById('idea-result');

            // --- Gemini (ì´ë¯¸ì§€) ìƒì„± ëª¨ë‹¬ UI ---
            const imageGenModal = document.getElementById('image-gen-modal');
            const imagePrompt = document.getElementById('image-prompt');
            const generateImageBtn = document.getElementById('generate-image-btn');
            const applyImageBtn = document.getElementById('apply-image-btn');
            const closeImageGenModal = document.getElementById('close-image-gen-modal');
            const imageLoading = document.getElementById('image-loading');
            const imagePreview = document.getElementById('image-preview');

            // --- (ì‹ ê·œ) ëŒ€ì‚¬ ì¶”ê°€ ëª¨ë‹¬ UI ---
            const textAddModal = document.getElementById('text-add-modal');
            const textInput = document.getElementById('text-input');
            const applyTextBtn = document.getElementById('apply-text-btn');
            const closeTextModalBtn = document.getElementById('close-text-modal');

            let currentEditingPanelId = null;
            let generatedImageUrl = null;

            // --- (ì‹ ê·œ) íˆ´ ì„ íƒ ë¡œì§ ---
            toolImageBtn.addEventListener('click', () => {
                currentTool = 'image';
                toolImageBtn.classList.add('active');
                toolTextBtn.classList.remove('active');
            });
            toolTextBtn.addEventListener('click', () => {
                currentTool = 'text';
                toolTextBtn.classList.add('active');
                toolImageBtn.classList.remove('active');
            });


            // --- ì½”ë¯¹ íŒ¨ë„ í´ë¦­ ì´ë²¤íŠ¸ (íˆ´ì— ë”°ë¼ ë¶„ê¸°) ---
            comicPanels.forEach(panel => {
                panel.addEventListener('click', () => {
                    currentEditingPanelId = panel.id;
                    
                    if (currentTool === 'image') {
                        // (ê¸°ì¡´) ì´ë¯¸ì§€ ìƒì„± ëª¨ë‹¬ ì—´ê¸°
                        imagePrompt.value = '';
                        imagePreview.innerHTML = 'AIê°€ ìƒì„±í•œ ê·¸ë¦¼ì´ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.';
                        imagePreview.classList.remove('hidden');
                        generatedImageUrl = null;
                        applyImageBtn.classList.add('hidden');
                        imageLoading.classList.add('hidden');
                        imageGenModal.classList.remove('hidden');
                    } else {
                        // (ì‹ ê·œ) ëŒ€ì‚¬ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
                        const currentPanel = document.getElementById(currentEditingPanelId);
                        const existingText = currentPanel.querySelector('.dialogue-text');
                        textInput.value = existingText ? existingText.textContent.replace(/\s+/g, ' ').trim() : ''; // \n ë“±ì„ ê³µë°±ìœ¼ë¡œ
                        textAddModal.classList.remove('hidden');
                    }
                });
            });

            // --- (ìˆ˜ì •) ì´ë¯¸ì§€ ìƒì„± ëª¨ë‹¬ ë¡œì§ (API ë³€ê²½) ---
            closeImageGenModal.addEventListener('click', () => {
                imageGenModal.classList.add('hidden');
            });

            generateImageBtn.addEventListener('click', () => {
                const prompt = imagePrompt.value;
                if (prompt) {
                    generateImageBtn.disabled = true;
                    generateImageBtn.classList.add('opacity-50');
                    imageLoading.classList.remove('hidden');
                    imagePreview.classList.add('hidden');
                    applyImageBtn.classList.add('hidden');
                    callImageGenApi(prompt);
                } else {
                    imagePreview.innerHTML = '<p class="text-red-500">ê·¸ë¦¼ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!</p>';
                    imagePreview.classList.remove('hidden');
                }
            });

            applyImageBtn.addEventListener('click', () => {
                if (generatedImageUrl && currentEditingPanelId) {
                    const panelToUpdate = document.getElementById(currentEditingPanelId);
                    panelToUpdate.style.backgroundImage = `url(${generatedImageUrl})`;
                    const placeholder = panelToUpdate.querySelector('.placeholder-text');
                    if (placeholder) placeholder.style.display = 'none';
                    imageGenModal.classList.add('hidden');
                }
            });

            // --- (ìˆ˜ì •) Gemini ì´ë¯¸ì§€ ìƒì„± API (Nano-banana, gemini-2.5-flash-image-preview) ---
            async function callImageGenApi(prompt, retries = 3, delay = 1000) {
                const apiKey = ""; // API í‚¤ëŠ” Canvas í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                
                // (ìˆ˜ì •) '4-cut comic style' ì œê±° -> 16ì»· ë§Œí™”ê°€ ë˜ëŠ” ë¬¸ì œ ìˆ˜ì •
                const fullPrompt = `A simple, cute, child-friendly cartoon drawing, clean lines. **No text, no letters, no dialogue bubbles.** Subject: ${prompt}`;
                
                const payload = {
                    contents: [{
                        parts: [{ text: fullPrompt }]
                    }],
                    generationConfig: {
                        responseModalities: ['TEXT', 'IMAGE']
                    },
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if ((response.status === 429 || response.status >= 500) && retries > 0) {
                            await new Promise(res => setTimeout(res, delay));
                            return callImageGenApi(prompt, retries - 1, delay * 2);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    // (ìˆ˜ì •) Nano-banana ì‘ë‹µ íŒŒì‹±
                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (base64Data) {
                        generatedImageUrl = `data:image/png;base64,${base64Data}`;
                        imagePreview.innerHTML = `<img src="${generatedImageUrl}" class="w-full h-auto rounded" alt="Generated Image">`;
                        applyImageBtn.classList.remove('hidden');
                    } else {
                        // í…ìŠ¤íŠ¸ëŠ” ìƒì„±ë˜ì—ˆìœ¼ë‚˜ ì´ë¯¸ì§€ê°€ ì—†ëŠ” ê²½ìš° (ì•ˆì „ í•„í„°ë§ ë“±)
                        const textResponse = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        throw new Error(textResponse || "APIì—ì„œ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    }

                } catch (error) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return callImageGenApi(prompt, retries - 1, delay * 2);
                    }
                    console.error("Image generation API error:", error);
                    imagePreview.innerHTML = `<p class="text-red-500">ê·¸ë¦¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì´ìœ : ${error.message})</p>`;
                } finally {
                    imageLoading.classList.add('hidden');
                    imagePreview.classList.remove('hidden');
                    generateImageBtn.disabled = false;
                    generateImageBtn.classList.remove('opacity-50');
                }
            }

            // --- (ì‹ ê·œ) ëŒ€ì‚¬ ì¶”ê°€ ëª¨ë‹¬ ë¡œì§ ---
            closeTextModalBtn.addEventListener('click', () => {
                textAddModal.classList.add('hidden');
            });

            applyTextBtn.addEventListener('click', () => {
                const text = textInput.value;
                const panelToUpdate = document.getElementById(currentEditingPanelId);
                
                // ê¸°ì¡´ ëŒ€ì‚¬ ì œê±°
                const existingText = panelToUpdate.querySelector('.dialogue-text');
                if (existingText) {
                    panelToUpdate.removeChild(existingText);
                }
                
                // ìƒˆ ëŒ€ì‚¬ ì¶”ê°€ (í…ìŠ¤íŠ¸ê°€ ìˆì„ ê²½ìš°ì—ë§Œ)
                if (text && text.trim() !== '') {
                    const textElement = document.createElement('p');
                    textElement.className = 'dialogue-text';
                    textElement.textContent = text;
                    panelToUpdate.appendChild(textElement);
                    
                    // í”Œë ˆì´ìŠ¤í™€ë” ìˆ¨ê¸°ê¸°
                    const placeholder = panelToUpdate.querySelector('.placeholder-text');
                    if (placeholder) placeholder.style.display = 'none';
                }
                
                textAddModal.classList.add('hidden');
            });


            // --- (ê¸°ì¡´) Gemini í…ìŠ¤íŠ¸ ì•„ì´ë””ì–´ ê¸°ëŠ¥ ---
            getIdeaBtn.addEventListener('click', () => {
                ideaModal.classList.remove('hidden');
                // ... (ì´í•˜ ë™ì¼)
                ideaResult.classList.add('hidden');
                ideaResult.innerHTML = '';
                ideaPromptInput.value = '';
                ideaLoading.classList.add('hidden');
            });

            closeIdeaModalBtn.addEventListener('click', () => {
                ideaModal.classList.add('hidden');
            });

            generateIdeaBtn.addEventListener('click', () => {
                const prompt = ideaPromptInput.value;
                if (prompt) {
                    generateIdeaBtn.disabled = true;
                    generateIdeaBtn.classList.add('opacity-50');
                    ideaLoading.classList.remove('hidden');
                    ideaResult.classList.add('hidden');
                    callTextGeminiApi(prompt);
                } else {
                    ideaResult.innerHTML = '<p class="text-red-500">ìë‘ê±°ë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!</p>';
                    ideaResult.classList.remove('hidden');
                }
            });

            async function callTextGeminiApi(prompt, retries = 3, delay = 1000) {
                // ... (ì´ í•¨ìˆ˜ëŠ” ë³€ê²½ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤) ...
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                const systemPrompt = "ë‹¹ì‹ ì€ ì•„ì´ë“¤ì„ ìœ„í•œ 4ì»· ë§Œí™” ìŠ¤í† ë¦¬ ì‘ê°€ì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ 'ìš°ë¦¬ ì§€ì—­ì˜ ìë‘ê±°ë¦¬'ë¥¼ ì£¼ì œë¡œ ì…ë ¥í•˜ë©´, ê·¸ ì£¼ì œì— ë§ëŠ” 4ì»· ë§Œí™”ì˜ ê° ì»· ë‚´ìš©ì„ 1-4ë²ˆìœ¼ë¡œ ë²ˆí˜¸ê°€ ë§¤ê²¨ì§„ ë¦¬ìŠ¤íŠ¸ë¡œ, ì•„ì£¼ ì§§ê³  ê°„ë‹¨í•œ ë¬¸ì¥ìœ¼ë¡œ ì œì•ˆí•©ë‹ˆë‹¤. ì•„ì´ë“¤ì´ ì´í•´í•˜ê¸° ì‰½ë„ë¡ ì¬ë¯¸ìˆê³  ê¸ì •ì ì¸ í†¤ì„ ìœ ì§€í•˜ì„¸ìš”.";
                const userQuery = `ìš°ë¦¬ ì§€ì—­ ìë‘ê±°ë¦¬: ${prompt}`;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        if ((response.status === 429 || response.status >= 500) && retries > 0) {
                            await new Promise(res => setTimeout(res, delay));
                            return callTextGeminiApi(prompt, retries - 1, delay * 2);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        displayIdeaResult(candidate.content.parts[0].text);
                    } else {
                        let errorText = "ì•„ì´ë””ì–´ë¥¼ ë°›ì•„ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                        if (candidate?.finishReason) {
                            errorText += ` (ì´ìœ : ${candidate.finishReason})`;
                        }
                        displayIdeaResult(`<p class='text-red-500'>${errorText}</p>`, true);
                    }
                } catch (error) {
                    if (retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return callTextGeminiApi(prompt, retries - 1, delay * 2);
                    }
                    console.error("Text Gemini API í˜¸ì¶œ ì˜¤ë¥˜:", error);
                    displayIdeaResult(`<p class='text-red-500'>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (${error.message})</p>`, true);
                } finally {
                    ideaLoading.classList.add('hidden');
                    generateIdeaBtn.disabled = false;
                    generateIdeaBtn.classList.remove('opacity-50');
                }
            }

            function displayIdeaResult(text, isError = false) {
                // ... (ì´ í•¨ìˆ˜ëŠ” ë³€ê²½ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤) ...
                if (isError) {
                    ideaResult.innerHTML = text;
                } else {
                    let htmlContent = text
                        .replace(/1\.\s*(.*)/g, '<p class="mb-1"><b>1ì»·:</b> $1</p>')
                        .replace(/2\.\s*(.*)/g, '<p class="mb-1"><b>2ì»·:</b> $1</p>')
                        .replace(/3\.\s*(.*)/g, '<p class="mb-1"><b>3ì»·:</b> $1</p>')
                        .replace(/4\.\s*(.*)/g, '<p><b>4ì»·:</b> $1</p>')
                        .replace(/\n/g, ' '); 
                    if (!htmlContent.includes('<b>')) {
                         htmlContent = text.split('\n').map((line, index) => {
                            if (line.trim()) {
                                return `<p class="mb-1"><b>${index+1}ì»·:</b> ${line.replace(/^\d+\.\s*/, '')}</p>`;
                            }
                            return '';
                        }).join('');
                    }
                    ideaResult.innerHTML = `<div class="text-sm text-left">${htmlContent}</div>`;
                }
                ideaResult.classList.remove('hidden');
            }
            
            // --- (ìˆ˜ì •) ê¸°íƒ€ ë²„íŠ¼ ë¡œì§ (ëŒ€ì‚¬ ì œê±° ì¶”ê°€) ---
            clearAllBtn.addEventListener('click', () => {
                comicPanels.forEach((panel, index) => {
                    panel.style.backgroundImage = 'none';
                    
                    // ê¸°ì¡´ ëŒ€ì‚¬ ì œê±°
                    const existingText = panel.querySelector('.dialogue-text');
                    if (existingText) {
                        panel.removeChild(existingText);
                    }
                    
                    // í”Œë ˆì´ìŠ¤í™€ë” í…ìŠ¤íŠ¸ ë‹¤ì‹œ ë³´ì´ê²Œ
                    const placeholder = panel.querySelector('.placeholder-text');
                    if (placeholder) {
                        placeholder.style.display = 'block';
                        placeholder.textContent = `${index + 1}ì»·: í´ë¦­í•´ì„œ ê·¸ë¦¼/ëŒ€ì‚¬ ì¶”ê°€`;
                    }
                });
            });

            saveBtn.addEventListener('click', () => {
                // ... (ì €ì¥ ë¡œì§ì€ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤) ...
                loadingModal.classList.remove('hidden');
                document.querySelectorAll('.placeholder-text').forEach(el => el.style.display = 'none');
                
                html2canvas(comicGrid, {
                    backgroundColor: '#e5e7eb',
                    scale: 2
                }).then(canvas => {
                    const a = document.createElement('a');
                    a.href = canvas.toDataURL('image/png');
                    a.download = 'my_region_comic_ai.png';
                    a.click();
                }).catch(err => {
                    console.error("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
                }).finally(() => {
                    comicPanels.forEach(panel => {
                        const hasImage = panel.style.backgroundImage && panel.style.backgroundImage !== 'none';
                        const hasText = panel.querySelector('.dialogue-text');
                        if (!hasImage && !hasText) {
                            const placeholder = panel.querySelector('.placeholder-text');
                            if (placeholder) {
                                placeholder.style.display = 'block';
                            }
                        }
                    });
                    loadingModal.classList.add('hidden');
                });
            });
        });
    </script>
</body>
</html>