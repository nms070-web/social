<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ ì§€ì—­ 4ì»· ë§Œí™” ë§Œë“¤ê¸° (AI ê·¸ë¦¼)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Jua&display=swap');
        body {
            font-family: 'Jua', 'Inter', sans-serif;
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .font-jua { font-family: 'Jua', sans-serif; }
        .comic-panel {
            background-color: #f3f4f6;
            border: 4px solid #4b5563;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #6b7280;
            font-size: 1.125rem;
            padding: 16px;
            background-size: cover;
            background-position: center;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .comic-panel:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }
        /* íŒ¨ë„ í”Œë ˆì´ìŠ¤í™€ë” í…ìŠ¤íŠ¸ */
        .comic-panel .placeholder-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }
        /* íŒ¨ë„ì— ì´ë¯¸ì§€ê°€ ì ìš©ë˜ë©´ í”Œë ˆì´ìŠ¤í™€ë” ìˆ¨ê¹€ */
        .comic-panel.has-image .placeholder-text,
        .comic-panel.has-dialogue .placeholder-text {
            display: none;
        }
        /* ëŒ€ì‚¬ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .dialogue-text {
            position: absolute;
            bottom: 8px;
            left: 8px;
            right: 8px;
            background-color: rgba(255, 255, 255, 0.95);
            border: 2px solid #4b5563;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 1rem;
            color: #1f2937;
            text-align: center;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            word-break: keep-all; /* ë‹¨ì–´ ë‹¨ìœ„ ì¤„ë°”ê¿ˆ */
        }
        /* ëŒ€ì‚¬ê°€ ìˆì„ ë•Œ í‘œì‹œ */
        .comic-panel.has-dialogue .dialogue-text {
            display: block;
        }
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 50; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10vh auto;
            padding: 24px;
            border: 1px solid #888;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6366F1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* í”„ë¡¬í”„íŠ¸ ê°€ì´ë“œ */
        .prompt-guide {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            font-size: 0.9rem;
            color: #374151;
            line-height: 1.6;
        }
        .prompt-guide strong {
            color: #4f46e5;
        }
        .prompt-guide code {
            background-color: #e5e7eb;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        /* íˆ´ í† ê¸€ ë²„íŠ¼ */
        .tool-toggle-group button {
            transition: all 0.2s;
        }
        .tool-toggle-group button[aria-pressed="true"] {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tool-toggle-group button[aria-pressed="false"] {
            background-color: #e5e7eb;
            color: #374151;
        }
        /* ì˜¤ë¥˜ ë©”ì‹œì§€ */
        #error-message {
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 100;
            font-size: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 font-jua">ğŸï¸ ìš°ë¦¬ ì§€ì—­ 4ì»· ë§Œí™” ë§Œë“¤ê¸° ğŸ¨</h1>
            <p class="text-gray-600 mt-2">AIë¡œ ê·¸ë¦¼ì„ ê·¸ë¦¬ê³ , ë‚˜ë§Œì˜ ëŒ€ì‚¬ë¥¼ ë„£ì–´ ë©‹ì§„ 4ì»· ë§Œí™”ë¥¼ ì™„ì„±í•´ ë³´ì„¸ìš”!</p>
        </header>

        <!-- íˆ´ë°” -->
        <div class="mb-4 p-4 bg-white rounded-xl shadow-md flex flex-wrap gap-4 items-center justify-center">
            
            <!-- íˆ´ ì„ íƒ -->
            <div class="tool-toggle-group flex rounded-lg border border-gray-300">
                <button id="tool-image" aria-pressed="true" class="font-jua px-4 py-2 rounded-l-lg text-sm md:text-base">
                    ğŸ–¼ï¸ ê·¸ë¦¼ ë„£ê¸°
                </button>
                <button id="tool-dialogue" aria-pressed="false" class="font-jua px-4 py-2 rounded-r-lg text-sm md:text-base">
                    ğŸ’¬ ëŒ€ì‚¬ ë„£ê¸°
                </button>
            </div>

            <!-- ê¸°íƒ€ ê¸°ëŠ¥ -->
            <button id="get-story-idea" class="font-jua px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg shadow transition text-sm md:text-base">
                âœ¨ ë§Œí™” ìŠ¤í† ë¦¬ ì¶”ì²œ
            </button>
            <button id="clear-all" class="font-jua px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg shadow transition text-sm md:text-base">
                ğŸ—‘ï¸ ëª¨ë‘ ë¹„ìš°ê¸°
            </button>
            <button id="download-comic" class="font-jua px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow transition text-sm md:text-base">
                ğŸ–¼ï¸ ë§Œí™” ì €ì¥í•˜ê¸°
            </button>
        </div>

        <!-- 4ì»· ë§Œí™” ê·¸ë¦¬ë“œ -->
        <div id="comic-grid" class="grid grid-cols-2 gap-4 md:gap-6">
            <div id="panel-1" class="comic-panel">
                <div class="placeholder-text">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="#9ca3af" viewBox="0 0 256 256"><path d="M224,40H32A16,16,0,0,0,16,56V200a16,16,0,0,0,16,16H224a16,16,0,0,0,16-16V56A16,16,0,0,0,224,40Zm0,16V164.38l-45.19-45.19a16,16,0,0,0-22.62,0L112,163.38l-18.3-18.3a16,16,0,0,0-22.62,0L32,184V56Zm0,144H32V195.6l45.09-45.09a16.14,16.14,0,0,0,.3-22.32L93.5,112l45.2,45.19a16,16,0,0,0,22.62,0L208,110.85V56h1.15l.23.23L224,70.85v123.3Z"></path></svg>
                    <span>1. í´ë¦­í•´ì„œ<br>ê·¸ë¦¼/ëŒ€ì‚¬ ì¶”ê°€</span>
                </div>
                <div class="dialogue-text"></div>
            </div>
            <div id="panel-2" class="comic-panel">
                <div class="placeholder-text">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="#9ca3af" viewBox="0 0 256 256"><path d="M224,40H32A16,16,0,0,0,16,56V200a16,16,0,0,0,16,16H224a16,16,0,0,0,16-16V56A16,16,0,0,0,224,40Zm0,16V164.38l-45.19-45.19a16,16,0,0,0-22.62,0L112,163.38l-18.3-18.3a16,16,0,0,0-22.62,0L32,184V56Zm0,144H32V195.6l45.09-45.09a16.14,16.14,0,0,0,.3-22.32L93.5,112l45.2,45.19a16,16,0,0,0,22.62,0L208,110.85V56h1.15l.23.23L224,70.85v123.3Z"></path></svg>
                    <span>2. í´ë¦­í•´ì„œ<br>ê·¸ë¦¼/ëŒ€ì‚¬ ì¶”ê°€</span>
                </div>
                <div class="dialogue-text"></div>
            </div>
            <div id="panel-3" class="comic-panel">
                <div class="placeholder-text">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="#9ca3af" viewBox="0 0 256 256"><path d="M224,40H32A16,16,0,0,0,16,56V200a16,16,0,0,0,16,16H224a16,16,0,0,0,16-16V56A16,16,0,0,0,224,40Zm0,16V164.38l-45.19-45.19a16,16,0,0,0-22.62,0L112,163.38l-18.3-18.3a16,16,0,0,0-22.62,0L32,184V56Zm0,144H32V195.6l45.09-45.09a16.14,16.14,0,0,0,.3-22.32L93.5,112l45.2,45.19a16,16,0,0,0,22.62,0L208,110.85V56h1.15l.23.23L224,70.85v123.3Z"></path></svg>
                    <span>3. í´ë¦­í•´ì„œ<br>ê·¸ë¦¼/ëŒ€ì‚¬ ì¶”ê°€</span>
                </div>
                <div class="dialogue-text"></div>
            </div>
            <div id="panel-4" class="comic-panel">
                <div class="placeholder-text">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="#9ca3af" viewBox="0 0 256 256"><path d="M224,40H32A16,16,0,0,0,16,56V200a16,16,0,0,0,16,16H224a16,16,0,0,0,16-16V56A16,16,0,0,0,224,40Zm0,16V164.38l-45.19-45.19a16,16,0,0,0-22.62,0L112,163.38l-18.3-18.3a16,16,0,0,0-22.62,0L32,184V56Zm0,144H32V195.6l45.09-45.09a16.14,16.14,0,0,0,.3-22.32L93.5,112l45.2,45.19a16,16,0,0,0,22.62,0L208,110.85V56h1.15l.23.23L224,70.85v123.3Z"></path></svg>
                    <span>4. í´ë¦­í•´ì„œ<br>ê·¸ë¦¼/ëŒ€ì‚¬ ì¶”ê°€</span>
                </div>
                <div class="dialogue-text"></div>
            </div>
        </div>
    </div>

    <!-- AI ì´ë¯¸ì§€ ìƒì„± ëª¨ë‹¬ -->
    <div id="image-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 font-jua">ğŸ–¼ï¸ ì»· ê·¸ë¦¼ ìƒì„±í•˜ê¸°</h2>
            <p class="text-gray-600 mb-4">AIì—ê²Œ ì–´ë–¤ ê·¸ë¦¼ì„ ê·¸ë ¤ë‹¬ë¼ê³  í• ê¹Œìš”?<br>ìš°ë¦¬ ì§€ì—­ì˜ ìë‘ê±°ë¦¬ë¥¼ ìì„¸íˆ ì„¤ëª…í•´ ì£¼ì„¸ìš”.</p>
            <textarea id="image-prompt" class="w-full h-24 p-3 border border-gray-300 rounded-lg resize-none" placeholder="ì˜ˆ: 'ì²­ì£¼ ì‚¼ê²¹ì‚´ ê±°ë¦¬'ì—ì„œ 'ë§›ìˆê²Œ ì‚¼ê²¹ì‚´ì„ êµ½ê³  ìˆëŠ”' 'ë¼ì§€ ìºë¦­í„°'"></textarea>
            
            <div class="prompt-guide">
                <strong class="font-jua">ğŸ’¡ ì´ë ‡ê²Œ ì„¤ëª…í•˜ë©´ ê·¸ë¦¼ì´ ì˜ ë‚˜ì™€ìš”!</strong>
                <ul class="list-disc list-inside mt-2">
                    <li><strong>[ëˆ„ê°€/ë¬´ì—‡ì„]</strong>: <code>ê·€ì—¬ìš´ ê°•ì•„ì§€</code>, <code>ìš©ê°í•œ ì†Œë°©ê´€</code></li>
                    <li><strong>[ì–´ë””ì—ì„œ]</strong>: <code>ì†ì´ˆ ë°”ë‹¤ ì•ì—ì„œ</code>, <code>ë©‹ì§„ ì„±ê³½ ìœ„ì—ì„œ</code></li>
                    <li><strong>[ë¬´ì—‡ì„ í•˜ë‚˜ìš”]</strong>: <code>ì‹ ë‚˜ê²Œ ì¶¤ì„ ì¶”ëŠ”</code>, <code>ì±…ì„ ì½ê³  ìˆëŠ”</code></li>
                </ul>
                <hr class="my-2 border-gray-300">
                <p><strong>[í•©ì³ë³´ê¸°]</strong> <code>'ì†ì´ˆ ë°”ë‹¤ ì•ì—ì„œ ì‹ ë‚˜ê²Œ ì¶¤ì„ ì¶”ëŠ” ê·€ì—¬ìš´ ê°•ì•„ì§€'</code></p>
            </div>

            <div id="image-preview-container" class="my-4" style="display: none;">
                <p class="font-bold text-gray-700">ë¯¸ë¦¬ë³´ê¸°:</p>
                <img id="image-preview" src="" alt="AI ìƒì„± ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" class="w-full h-auto rounded-lg border border-gray-300 mt-2">
            </div>
            
            <div id="image-loader" class="loader" style="display: none;"></div>

            <div class="flex justify-end gap-3 mt-4">
                <button id="close-image-modal" class="font-jua px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">ì·¨ì†Œ</button>
                <button id="apply-image" class="font-jua px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg" style="display: none;">ì´ ê·¸ë¦¼ìœ¼ë¡œ ì ìš©</button>
                <button id="generate-image" class="font-jua px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">ê·¸ë¦¼ ìƒì„±í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ëŒ€ì‚¬ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="dialogue-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 font-jua">ğŸ’¬ ëŒ€ì‚¬ ë„£ê¸°</h2>
            <p class="text-gray-600 mb-4">ë§Œí™” ì»·ì— ë“¤ì–´ê°ˆ ëŒ€ì‚¬ë‚˜ ì„¤ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
            <textarea id="dialogue-prompt" class="w-full h-24 p-3 border border-gray-300 rounded-lg resize-none" placeholder="ì˜ˆ: ì™€! ì •ë§ ë§›ìˆë‹¤!"></textarea>
            <div class="flex justify-end gap-3 mt-4">
                <button id="clear-dialogue" class="font-jua px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg">ëŒ€ì‚¬ ì§€ìš°ê¸°</button>
                <button id="close-dialogue-modal" class="font-jua px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">ì·¨ì†Œ</button>
                <button id="apply-dialogue" class="font-jua px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">ëŒ€ì‚¬ ì ìš©í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ë§Œí™” ìŠ¤í† ë¦¬ ì¶”ì²œ ëª¨ë‹¬ -->
    <div id="story-idea-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 font-jua">âœ¨ ë§Œí™” ì•„ì´ë””ì–´ ìƒì„±ê¸°</h2>
            <p class="text-gray-600 mb-4">ë§Œí™”ë¡œ ë§Œë“¤ê³  ì‹¶ì€ 'ìš°ë¦¬ ì§€ì—­ ìë‘ê±°ë¦¬'ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”. AIê°€ 4ì»· ë§Œí™” ìŠ¤í† ë¦¬ë¥¼ ì¶”ì²œí•´ ì¤„ê²Œìš”!</p>
            <input type="text" id="story-idea-prompt" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: ì²­ì£¼ ì‚¼ê²¹ì‚´, ë¶€ì‚° í•´ìš´ëŒ€, ì „ì£¼ í•œì˜¥ë§ˆì„">
            
            <div id="story-idea-loader" class="loader" style="display: none;"></div>
            
            <div id="story-idea-result" class="mt-4 p-3 bg-gray-100 rounded-lg" style="display: none;">
                <!-- AIê°€ ìƒì„±í•œ ìŠ¤í† ë¦¬ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            
            <div class="flex justify-end gap-3 mt-4">
                <button id="close-story-idea-modal" class="font-jua px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">ë‹«ê¸°</button>
                <button id="generate-story-idea" class="font-jua px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">ì•„ì´ë””ì–´ ìƒì„±!</button>
            </div>
        </div>
    </div>

    <!-- ì˜¤ë¥˜ ë©”ì‹œì§€ ì•Œë¦¼ -->
    <div id="error-message">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // === ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì • ===
        // !!! ì¤‘ìš” !!!
        // ì—¬ê¸°ì— Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        const apiKey = "AIzaSyC05_m1GLE3hcq4hgzXWYbZX9EBYz31qCw"; // ì˜ˆ: "AIzaSy...your...api...key"

        let currentTool = 'image'; // 'image' ë˜ëŠ” 'dialogue'
        let currentPanel = null; // í˜„ì¬ ì„ íƒëœ íŒ¨ë„ (panel-1, panel-2 ë“±)
        const maxRetries = 3; // API ì¬ì‹œë„ íšŸìˆ˜
        
        // ëª¨ë¸ ì´ë¦„
        const IMAGE_GEN_MODEL = "gemini-2.5-flash-image-preview"; // ë‚˜ë…¸ë°”ë‚˜ë‚˜ (ì´ë¯¸ì§€ ìƒì„±)
        const TEXT_GEN_MODEL = "gemini-2.5-flash-preview-09-2025"; // í…ìŠ¤íŠ¸ ìƒì„± (ìŠ¤í† ë¦¬ ì¶”ì²œ)

        // === DOM ìš”ì†Œ ===
        const toolImageBtn = document.getElementById('tool-image');
        const toolDialogueBtn = document.getElementById('tool-dialogue');
        const panels = document.querySelectorAll('.comic-panel');
        const clearAllBtn = document.getElementById('clear-all');
        const downloadBtn = document.getElementById('download-comic');
        const errorMessage = document.getElementById('error-message');

        // ì´ë¯¸ì§€ ëª¨ë‹¬
        const imageModal = document.getElementById('image-modal');
        const closeImageModalBtn = document.getElementById('close-image-modal');
        const generateImageBtn = document.getElementById('generate-image');
        const applyImageBtn = document.getElementById('apply-image');
        const imagePrompt = document.getElementById('image-prompt');
        const imageLoader = document.getElementById('image-loader');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        let generatedImageData = null; // AIê°€ ìƒì„±í•œ ì´ë¯¸ì§€ base64 ë°ì´í„°

        // ëŒ€ì‚¬ ëª¨ë‹¬
        const dialogueModal = document.getElementById('dialogue-modal');
        const closeDialogueModalBtn = document.getElementById('close-dialogue-modal');
        const applyDialogueBtn = document.getElementById('apply-dialogue');
        const clearDialogueBtn = document.getElementById('clear-dialogue');
        const dialoguePrompt = document.getElementById('dialogue-prompt');

        // ìŠ¤í† ë¦¬ ì¶”ì²œ ëª¨ë‹¬
        const storyIdeaModal = document.getElementById('story-idea-modal');
        const getStoryIdeaBtn = document.getElementById('get-story-idea');
        const closeStoryIdeaModalBtn = document.getElementById('close-story-idea-modal');
        const generateStoryIdeaBtn = document.getElementById('generate-story-idea');
        const storyIdeaPrompt = document.getElementById('story-idea-prompt');
        const storyIdeaLoader = document.getElementById('story-idea-loader');
        const storyIdeaResult = document.getElementById('story-idea-result');


        // === íˆ´ ì„ íƒ ===
        function setTool(tool) {
            currentTool = tool;
            if (tool === 'image') {
                toolImageBtn.setAttribute('aria-pressed', 'true');
                toolDialogueBtn.setAttribute('aria-pressed', 'false');
            } else {
                toolImageBtn.setAttribute('aria-pressed', 'false');
                toolDialogueBtn.setAttribute('aria-pressed', 'true');
            }
        }

        toolImageBtn.addEventListener('click', () => setTool('image'));
        toolDialogueBtn.addEventListener('click', () => setTool('dialogue'));

        // === íŒ¨ë„ í´ë¦­ ì´ë²¤íŠ¸ ===
        panels.forEach(panel => {
            panel.addEventListener('click', () => {
                currentPanel = panel.id; // ì˜ˆ: "panel-1"
                if (currentTool === 'image') {
                    openImageModal();
                } else {
                    openDialogueModal();
                }
            });
        });

        // === ì´ë¯¸ì§€ ìƒì„± ëª¨ë‹¬ ===
        function openImageModal() {
            // ëª¨ë‹¬ ì´ˆê¸°í™”
            imagePrompt.value = '';
            imagePreview.src = '';
            imagePreviewContainer.style.display = 'none';
            applyImageBtn.style.display = 'none';
            generateImageBtn.style.display = 'block';
            imageLoader.style.display = 'none';
            generatedImageData = null;
            imageModal.style.display = 'flex';
        }

        closeImageModalBtn.addEventListener('click', () => {
            imageModal.style.display = 'none';
        });

        generateImageBtn.addEventListener('click', async () => {
            const prompt = imagePrompt.value;
            if (!prompt) {
                showError("ê·¸ë¦¼ ì„¤ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!");
                return;
            }
            if (!apiKey) {
                showError("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            // í”„ë¡¬í”„íŠ¸ì— 'ê¸€ì ì—†ìŒ' ì§€ì‹œì–´ ì¶”ê°€
            const finalPrompt = `${prompt}. ì•„ì´ë“¤ì´ ë³´ëŠ” ë§Œí™” ìŠ¤íƒ€ì¼. No text, no letters, no dialogue bubbles.`;

            // UI ì—…ë°ì´íŠ¸
            generateImageBtn.style.display = 'none';
            imageLoader.style.display = 'block';
            imagePreviewContainer.style.display = 'none';

            try {
                generatedImageData = await callImageGenApi(finalPrompt);
                
                if (generatedImageData) {
                    imagePreview.src = `data:image/png;base64,${generatedImageData}`;
                    imagePreviewContainer.style.display = 'block';
                    applyImageBtn.style.display = 'block';
                } else {
                    throw new Error("ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error('Image generation error:', error);
                showError(`ê·¸ë¦¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì´ìœ : ${error.message})`);
                generateImageBtn.style.display = 'block'; // ë²„íŠ¼ ë³µêµ¬
            } finally {
                imageLoader.style.display = 'none';
            }
        });

        applyImageBtn.addEventListener('click', () => {
            if (generatedImageData && currentPanel) {
                const panel = document.getElementById(currentPanel);
                panel.style.backgroundImage = `url('data:image/png;base64,${generatedImageData}')`;
                panel.classList.add('has-image');
                imageModal.style.display = 'none';
            }
        });

        // === ëŒ€ì‚¬ ì…ë ¥ ëª¨ë‹¬ ===
        function openDialogueModal() {
            const panel = document.getElementById(currentPanel);
            const currentDialogue = panel.querySelector('.dialogue-text').textContent;
            dialoguePrompt.value = currentDialogue;
            dialogueModal.style.display = 'flex';
        }

        closeDialogueModalBtn.addEventListener('click', () => {
            dialogueModal.style.display = 'none';
        });

        applyDialogueBtn.addEventListener('click', () => {
            const dialogue = dialoguePrompt.value;
            const panel = document.getElementById(currentPanel);
            const dialogueEl = panel.querySelector('.dialogue-text');

            if (dialogue) {
                dialogueEl.textContent = dialogue;
                panel.classList.add('has-dialogue');
            } else {
                // ëŒ€ì‚¬ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì œê±°
                dialogueEl.textContent = '';
                panel.classList.remove('has-dialogue');
            }
            dialogueModal.style.display = 'none';
        });

        clearDialogueBtn.addEventListener('click', () => {
            dialoguePrompt.value = '';
            // ì ìš© ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ì‹¤ì œ íŒ¨ë„ì—ì„œ ì§€ì›Œì§‘ë‹ˆë‹¤.
            // ë˜ëŠ”, ì—¬ê¸°ì„œ ë°”ë¡œ ì§€ìš¸ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
            const panel = document.getElementById(currentPanel);
            panel.querySelector('.dialogue-text').textContent = '';
            panel.classList.remove('has-dialogue');
            dialogueModal.style.display = 'none';
        });

        // === ìŠ¤í† ë¦¬ ì¶”ì²œ ëª¨ë‹¬ ===
        getStoryIdeaBtn.addEventListener('click', () => {
            storyIdeaPrompt.value = '';
            storyIdeaResult.style.display = 'none';
            storyIdeaLoader.style.display = 'none';
            storyIdeaModal.style.display = 'flex';
        });

        closeStoryIdeaModalBtn.addEventListener('click', () => {
            storyIdeaModal.style.display = 'none';
        });

        generateStoryIdeaBtn.addEventListener('click', async () => {
            const prompt = storyIdeaPrompt.value;
            if (!prompt) {
                showError("ì§€ì—­ ìë‘ê±°ë¦¬ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”!");
                return;
            }
            if (!apiKey) {
                showError("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì§€ì‹œ)
            const systemPrompt = "ë‹¹ì‹ ì€ 4ì»· ë§Œí™” ì‹œë‚˜ë¦¬ì˜¤ ì‘ê°€ì…ë‹ˆë‹¤. ì•„ì´ë“¤ì´ ì´í•´í•˜ê¸° ì‰½ë„ë¡, 4ì»· ë§Œí™” ìŠ¤í† ë¦¬ë¥¼ 4ê°œì˜ ê°„ë‹¨í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”. ê° ë¬¸ì¥ì€ 1. 2. 3. 4. í˜•ì‹ìœ¼ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤.";
            const userPrompt = `"${prompt}"ì— ëŒ€í•œ 4ì»· ë§Œí™” ìŠ¤í† ë¦¬`;

            storyIdeaLoader.style.display = 'block';
            storyIdeaResult.style.display = 'none';

            try {
                const story = await callTextGenApi(systemPrompt, userPrompt);
                
                if (story) {
                    // AI ì‘ë‹µì„ HTMLë¡œ ë³€í™˜ (ì¤„ë°”ê¿ˆ ì²˜ë¦¬)
                    storyIdeaResult.innerHTML = story.replace(/\n/g, '<br>');
                    storyIdeaResult.style.display = 'block';
                } else {
                    throw new Error("ìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                console.error('Story generation error:', error);
                showError(`ìŠ¤í† ë¦¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì´ìœ : ${error.message})`);
            } finally {
                storyIdeaLoader.style.display = 'none';
            }
        });


        // === ê¸°íƒ€ ê¸°ëŠ¥ ===
        clearAllBtn.addEventListener('click', () => {
            panels.forEach(panel => {
                panel.style.backgroundImage = 'none';
                panel.classList.remove('has-image');
                panel.querySelector('.dialogue-text').textContent = '';
                panel.classList.remove('has-dialogue');
            });
        });

        downloadBtn.addEventListener('click', () => {
            // ë‹¤ìš´ë¡œë“œ ì‹œ íŒ¨ë„ í…Œë‘ë¦¬ê°€ ì˜ë¦¬ì§€ ì•Šë„ë¡ ê·¸ë¦¬ë“œ ì˜ì—­ì„ ì €ì¥
            const grid = document.getElementById('comic-grid');
            html2canvas(grid, {
                scale: 2, // í•´ìƒë„ 2ë°°ë¡œ ì €ì¥
                backgroundColor: null // ë°°ê²½ìƒ‰ íˆ¬ëª…í•˜ê²Œ (ë¶€ëª¨ ë°°ê²½ìƒ‰ ì‚¬ìš©)
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'my_region_comic_ai.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(err => {
                console.error('Download error:', err);
                showError("ë§Œí™” ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        });

        // === ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ ===
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 3000); // 3ì´ˆ í›„ ì‚¬ë¼ì§
        }

        // === API í˜¸ì¶œ (Exponential Backoff í¬í•¨) ===

        /**
         * API í˜¸ì¶œì„ ì¬ì‹œë„ì™€ í•¨ê»˜ ìˆ˜í–‰í•˜ëŠ” ë˜í¼ í•¨ìˆ˜
         * @param {string} apiUrl - API ì—”ë“œí¬ì¸íŠ¸ URL
         * @param {object} payload - API ìš”ì²­ ë³¸ë¬¸
         * @param {number} retryCount - í˜„ì¬ ì¬ì‹œë„ íšŸìˆ˜
         * @returns {Promise<object>} API ì‘ë‹µ JSON
         */
        async function fetchWithRetry(apiUrl, payload, retryCount = 0) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    // !!! ì¤‘ìš” !!!
                    // ê¹ƒí—ˆë¸Œì—ì„œ 403 ì˜¤ë¥˜ê°€ ë°œìƒí•  ë•Œ, `referrerPolicy`ê°€ ì›ì¸ì´ì—ˆìŠµë‹ˆë‹¤.
                    // ì´ ì½”ë“œë¥¼ ì‚­ì œí•˜ì—¬ ë¸Œë¼ìš°ì €ì˜ ê¸°ë³¸ ì •ì±…(ì£¼ì†Œ(referer)ë¥¼ ë³´ëƒ„)ì„ ë”°ë¥´ë„ë¡ í•©ë‹ˆë‹¤.
                    // ì´ë ‡ê²Œ í•´ì•¼ Google Cloud Consoleì˜ 'HTTP ë¦¬í¼ëŸ¬' ì„¤ì •ì´ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•©ë‹ˆë‹¤.
                    // referrerPolicy: "no-referrer" // <--- ì´ ì½”ë“œë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();

            } catch (error) {
                if (retryCount < maxRetries) {
                    const delay = Math.pow(2, retryCount) * 1000; // 1s, 2s, 4s
                    console.warn(`API call failed, retrying in ${delay}ms... (Attempt ${retryCount + 1})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(apiUrl, payload, retryCount + 1);
                } else {
                    console.error('API call failed after max retries:', error);
                    throw new Error(`ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜(${maxRetries}íšŒ)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ${error.message}`);
                }
            }
        }

        /**
         * (Nano-Banana) ì´ë¯¸ì§€ ìƒì„± API í˜¸ì¶œ
         * @param {string} prompt - ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸
         * @returns {Promise<string>} Base64 ì¸ì½”ë”©ëœ ì´ë¯¸ì§€ ë°ì´í„°
         */
        async function callImageGenApi(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_GEN_MODEL}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE']
                },
            };

            const result = await fetchWithRetry(apiUrl, payload);
            
            // ì‘ë‹µ êµ¬ì¡° í™•ì¸ (nano-banana)
            const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
            if (!base64Data) {
                console.error("Invalid response structure from Image API:", result);
                throw new Error("API ì‘ë‹µì—ì„œ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            return base64Data;
        }

        /**
         * í…ìŠ¤íŠ¸ ìƒì„± API í˜¸ì¶œ (ìŠ¤í† ë¦¬ ì¶”ì²œìš©)
         * @param {string} systemPrompt - ì‹œìŠ¤í…œ ì§€ì‹œì–´
         * @param {string} userPrompt - ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸
         * @returns {Promise<string>} ìƒì„±ëœ í…ìŠ¤íŠ¸
         */
        async function callTextGenApi(systemPrompt, userPrompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_GEN_MODEL}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };
            
            const result = await fetchWithRetry(apiUrl, payload);

            // ì‘ë‹µ êµ¬ì¡° í™•ì¸ (gemini-flash)
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) {
                console.error("Invalid response structure from Text API:", result);
                throw new Error("API ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            return text;
        }

    </script>
</body>
</html>