<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나노바나나 캐릭터 생성기</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 기본 폰트 및 배경색 설정 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        /* 로딩 스피너 (Tailwind의 animate-spin 사용) */
    </style>
</head>
<body class="font-sans w-full min-h-screen bg-gray-900 text-white p-6 md:p-10">

    <div class="max-w-4xl mx-auto">
        <!-- 헤더 -->
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">
                나노바나나 캐릭터 생성기
            </h1>
            <p class="text-lg text-gray-300">
                학생 여러분의 상상력을 위한 캐릭터 제작 도우미입니다.
            </p>
        </header>

        <!-- 프롬프트 입력 섹션 -->
        <div class="p-6 md:p-8 bg-gray-800/50 rounded-2xl shadow-xl border border-gray-700">
            <h2 class="text-2xl font-semibold mb-6 text-blue-300">1. 어떤 캐릭터를 만들까요?</h2>
            <p class="mb-8 text-gray-400">
                아래 항목들을 자세히 적어줄수록 AI가 더 멋진 그림을 그려줄 거예요.
                (모든 항목은 영어로 적는 것을 권장합니다.)
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- 입력 필드: 캐릭터 묘사 -->
                <div class="w-full">
                    <label for="description-input" class="block text-sm font-medium text-gray-300 mb-2">캐릭터 묘사 (외형)</label>
                    <input type="text" id="description-input" placeholder="e.g. A brave knight with shining armor" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-2 text-xs text-gray-400">얼굴, 머리 스타일, 옷차림, 들고 있는 물건 등</p>
                </div>
                <!-- 입력 필드: 아트 스타일 -->
                <div class="w-full">
                    <label for="style-input" class="block text-sm font-medium text-gray-300 mb-2">아트 스타일</label>
                    <input type="text" id="style-input" placeholder="e.g. Anime style, Pixar 3D style, Pixel art" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-2 text-xs text-gray-400">만화, 3D, 픽셀 아트, 유화, 수채화 등</p>
                </div>
                <!-- 입력 필드: 배경 -->
                <div class="w-full">
                    <label for="setting-input" class="block text-sm font-medium text-gray-300 mb-2">배경 / 설정</label>
                    <input type="text" id="setting-input" placeholder="e.g. In a magical forest, On a futuristic city street" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-2 text-xs text-gray-400">캐릭터가 어디에 있나요?</p>
                </div>
                <!-- 입력 필드: 행동 -->
                <div class="w-full">
                    <label for="action-input" class="block text-sm font-medium text-gray-300 mb-2">행동 / 자세</label>
                    <input type="text" id="action-input" placeholder="e.g. Reading a glowing book, Running fast" class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="mt-2 text-xs text-gray-400">캐릭터가 무엇을 하고 있나요?</p>
                </div>
            </div>

            <!-- 생성 버튼 -->
            <button id="generate-button" class="w-full py-4 px-6 rounded-lg text-lg font-bold transition-all duration-300 ease-in-out bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 shadow-lg transform hover:-translate-y-1">
                나만의 캐릭터 생성하기 ✨
            </button>
        </div>

        <!-- 결과 표시 섹션 -->
        <div class="mt-10">
            <h2 class="text-2xl font-semibold mb-6 text-center text-blue-300">2. 생성된 캐릭터</h2>
            <div id="results-container" class="min-h-[300px] flex justify-center items-center p-6 bg-gray-800/50 rounded-2xl border border-gray-700 overflow-hidden">
                
                <!-- 기본 안내 메시지 (기본으로 보임) -->
                <p id="placeholder-text" class="text-gray-400 text-center">
                    위에서 캐릭터 설정을 입력하고 생성 버튼을 눌러주세요.
                    <br>
                    (Tip: 프롬프트를 영어로 작성하면 더 좋은 결과가 나옵니다!)
                </p>

                <!-- 로딩 스피너 (숨겨져 있음) -->
                <div id="loading-spinner" class="hidden flex-col justify-center items-center w-full h-full">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
                    <span class="ml-4 text-lg text-gray-300 mt-4">캐릭터를 생성 중입니다...</span>
                </div>

                <!-- 오류 메시지 (숨겨져 있음) -->
                <div id="error-message" class="hidden w-full p-4 bg-red-900/50 border border-red-700 rounded-lg text-red-300">
                    <p class="font-semibold">오류 발생!</p>
                    <p id="error-text" class="text-sm">오류 메시지가 여기에 표시됩니다.</p>
                </div>

                <!-- 생성된 이미지 (숨겨져 있음) -->
                <div id="image-container" class="hidden w-full max-w-lg mx-auto p-4 bg-gray-800 rounded-lg shadow-inner">
                    <img id="image-display" src="" alt="생성된 캐릭터 이미지" class="w-full h-auto rounded-md object-contain">
                </div>

            </div>
        </div>
        
        <!-- 모델 정보 푸터 -->
        <footer class="text-center mt-10 text-xs text-gray-500">
            Powered by Google Nano-Banana (gemini-2.5-flash-image-preview)
        </footer>
    </div>

    <script>
        // DOM이 로드된 후 스크립트 실행
        document.addEventListener('DOMContentLoaded', () => {
            // HTML 요소 가져오기
            const descriptionInput = document.getElementById('description-input');
            const styleInput = document.getElementById('style-input');
            const settingInput = document.getElementById('setting-input');
            const actionInput = document.getElementById('action-input');
            const generateButton = document.getElementById('generate-button');
            
            // 결과 표시 요소
            const resultsContainer = document.getElementById('results-container');
            const placeholderText = document.getElementById('placeholder-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const imageContainer = document.getElementById('image-container');
            const imageDisplay = document.getElementById('image-display');

            /**
             * 결과 영역의 상태를 관리하는 함수
             * @param {'default' | 'loading' | 'success' | 'error'} state - 표시할 상태
             * @param {string} [data] - (옵션) 'success'일 경우 이미지 URL, 'error'일 경우 오류 메시지
             */
            function showState(state, data) {
                // 모든 결과 요소를 숨김
                placeholderText.classList.add('hidden');
                loadingSpinner.classList.add('hidden');
                errorMessage.classList.add('hidden');
                imageContainer.classList.add('hidden');
                // 로딩 중일 때 버튼 비활성화
                generateButton.disabled = state === 'loading';
                generateButton.textContent = state === 'loading' ? '캐릭터 생성 중...' : '나만의 캐릭터 생성하기 ✨';
                if(state === 'loading') {
                    generateButton.classList.add('bg-gray-600', 'cursor-not-allowed');
                } else {
                    generateButton.classList.remove('bg-gray-600', 'cursor-not-allowed');
                }


                // 요청된 상태에 맞는 요소만 표시
                switch (state) {
                    case 'loading':
                        loadingSpinner.classList.remove('hidden');
                        loadingSpinner.classList.add('flex'); // flex-col을 위해 flex로 설정
                        break;
                    case 'success':
                        imageDisplay.src = data;
                        imageContainer.classList.remove('hidden');
                        break;
                    case 'error':
                        errorText.textContent = data || '알 수 없는 오류가 발생했습니다.';
                        errorMessage.classList.remove('hidden');
                        break;
                    case 'default':
                    default:
                        placeholderText.classList.remove('hidden');
                        break;
                }
            }

            /**
             * API 호출을 위한 재시도 로직(Exponential Backoff)을 포함한 fetch 함수
             */
            async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (response.ok) {
                            return response.json();
                        }
                        if (response.status === 429 || response.status >= 500) {
                            await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                            continue;
                        }
                        return response.json();
                    } catch (error) {
                        if (i === retries - 1) throw error;
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    }
                }
                throw new Error('최대 재시도 횟수에 도달했습니다.');
            }

            /**
             * 이미지 생성 API 호출 함수
             */
            async function generateCharacter() {
                showState('loading');

                const userPrompt = `
                    Create an image of a character.
                    Description: ${descriptionInput.value || 'a person'}.
                    Action: ${actionInput.value || 'standing'}.
                    Setting: ${settingInput.value || 'simple background'}.
                    Art Style: ${styleInput.value || 'digital art'}.
                `;

                const apiKey = ""; // API 키 (비워둠)
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{
                        parts: [{ text: userPrompt }]
                    }],
                    generationConfig: {
                        responseModalities: ['TEXT', 'IMAGE']
                    },
                };

                try {
                    const result = await fetchWithRetry(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                    if (base64Data) {
                        showState('success', `data:image/png;base64,${base64Data}`);
                    } else {
                        console.error("API 응답에 이미지 데이터가 없습니다:", result);
                        let errorMessageText = '이미지 생성에 실패했습니다.';
                        if (result?.error) {
                            errorMessageText = `[${result.error.code}] ${result.error.message}`;
                        } else if (result?.candidates?.[0]?.finishReason) {
                            errorMessageText = `생성을 완료하지 못했습니다. (Reason: ${result.candidates[0].finishReason})`;
                        }
                        showState('error', errorMessageText);
                    }
                } catch (err) {
                    console.error("API 호출 중 네트워크 오류:", err);
                    showState('error', `네트워크 오류가 발생했습니다: ${err.message}. 잠시 후 다시 시도해 주세요.`);
                }
            }

            // 생성 버튼에 클릭 이벤트 리스너 추가
            generateButton.addEventListener('click', generateCharacter);
        });
    </script>
</body>
</html>